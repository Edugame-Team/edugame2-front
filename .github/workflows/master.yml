name: Deploy on Production
on:
  push:
    branches:
      - master
jobs:
  deploy:
    name: Deploy on production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Get current version
        run:  echo "EDUGAME_PROJECT_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      #- name: Cache Docker layers
      #  uses: actions/cache@v2
      #  with:
      #    path: /tmp/.buildx-cache
      #    key: ${{ runner.os }}-buildx-${{ github.sha }}
      #    restore-keys: |
      #    ${{ runner.os }}-buildx-
      #
      #   cache-from: type=registry,ref=hustakin/hello-world-docker-action:latest
      #   cache-to: type=inline
      #   tags: hustakin/hello-world-docker-action:latest
      #   build-args: PROFILE=nectar,ARG2=test

      - name: Get Manifest
        run:  |
          curl 'hub.docker.com/v2/edugame/front/manifests/${{ env.EDUGAME_PROJECT_VERSION }}' \
          -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' \
          -H "Authorization: Bearer ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" \
          > manifest.json

      - name: cat man
        run: cat  manifest.json

      - name: Add tag
        run: |
          curl -PUT 'hub.docker.com/v2/edugame/front/manifests/production' \
          -H 'content-type: application/vnd.docker.distribution.manifest.v2+json' \
          -H "Authorization: Bearer ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" \
          -d '@manifest.json'

      #- name: Tag Release
      #  uses: shrink/actions-docker-registry-tag@v1
      #  with:
      #    registry: hub.docker.com/v2/edugame
      #    token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      #    repository: front
      #    target: ${{ env.EDUGAME_PROJECT_VERSION }}
      #    tags: |
      #      production
